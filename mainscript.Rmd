---
title: "Main code"
output: 
  github_document:
    toc: true
date: "6/18/2021"
editor_options: 
  chunk_output_type: console
---

The following analyses is conducted on spectra data for 119 specimens. Sample sizes for each specimen category compose of the following:

| Bullock's oriole | |   | Baltimore oriole |   |
|----------|----------|----------|----------|----------|
| Historic | Modern | Reference | Historic | Modern |
| 20 | 20 | 40 | 20 | 19 |

Bullock's reference specimens come from the Museum of Vertebrate Zoology (MVZ; n = 20) and the University of Washington Burke Museum (UWBM; n = 20), all from CA, NE, WA, OR, AZ.  

**Set up**: integration time, 100 ms; 10 readings averaged per recording; boxcar width 10

Each specimen has 5 patches measured (2 black 3 orange) and each patch is measured 3 times; i.e. 15 measurements per specimen. 

![**Fig 1**. Patches measured on specimens.](pics.png){width=30%}

<br>

### Load libraries
Using `pavo` as main, rest as data manipulation & organization
```{r Load libraries, message = FALSE, results = "hide", warning = FALSE}
library(pavo)
library(data.table)
library(readxl)
library(tidyverse)
library(stringr)
library(knitr)
library(car)
library(ggpubr)
library(ggpmisc)
library(lme4)
library(cowplot)
```

Set ggplot themes for figures
```{r ggplot theme}
mytheme <- theme(
  plot.title = element_text(size=20,face="bold",color="black"),      
  axis.text=element_text(size=16, color="black"),
  axis.title=element_text(size=18,face="bold",color="black"),
  axis.text.x=element_text(size=16, color="black"), 
  axis.text.y=element_text(size=16, color="black"),
  legend.text = element_text(size=16, color="black"),
  legend.title = element_text(size=16, color="black", face="bold"))

pal1 <- c("#ffa600", "#58508d")
```

# Import data
## Attribute data
Load `specimen_info.xls` & filter out necessary info

```{r Attribute data, message = FALSE, warning=FALSE}
attributes <- read_excel("oriole_specimen_info.xlsx")
knitr::kable(head(attributes))

attributes$date <- as.Date(attributes$CollectionDate, origin = "1899-12-30")

att <- attributes[,c("ID", "sp_id", "cat", "date", "Code")]
att$cat <- as.factor(att$cat)

# Just IDs and category
idcat <- att[,c("ID", "cat")]
```


<br>


## Spectra data 
Finds and imports spectra files from a folder `allspec` and `burke`. Contains replicated data for one missing measurement. 

```{r Load specs, message = FALSE, results = "hide"}
spec <- getspec("allspec", ext = "txt", lim = c(300, 700))  # 1485 files
spec <- as.rspec(spec)

burke <- getspec("burke", ext = "txt", lim = c(300, 700)) #300 files
```

## Visually check spectra
```{r See other spectra, message = FALSE, fig.cap = "**Fig 2a.** Spectra of specimens measured in 2019."}
plot(spec)
```

```{r See burke spectra, message = FALSE, fig.cap = "**Fig 2b.** Spectra of UWBM specimens measured in 2021."}
plot(burke)
```


### Fix odd peaks
Measurements for the Burke museum specimen have two peaks in the spectra that occur for unknown reasons. They were replaced by deleting reflectance at those wavelengths and interpolating the values from before/after. The areas of concern seem to be 470-500 nm and 510-560 nm. 

 1. Replace odd wavelengths with `NA`
 2. Use `as.rspec` to interpolate gaps
```{r Fix weird specs, message = FALSE}
wl <- burke$wl

# replace with NA
burke$wl <- as.numeric(burke$wl)

burke[which(burke$wl > 470 & burke$wl < 500),] <- NA
burke[which(burke$wl > 515 & burke$wl < 560),] <- NA

burke[,1] <- wl # feed back in because it gets deleted

# Interpolate
burke <- as.rspec(burke)

# join 
allspec <- merge(spec, burke)
```

3. Check new spectra

```{r See new burke spectra, message = FALSE, fig.cap = "**Fig 2c.** Spectra of UWBM specimens"}
plot(burke)
```

<br>

## Average spectra
Modify names for future processing.
```{r Modify names for processing, echo = FALSE, message = FALSE}
# average spectra (3 measurements per patch) per specimen part
m.allspec <- aggspec(allspec, by = 3, FUN = mean, trim = FALSE)

# change values to color patch names
allsp.id <- names(m.allspec)
allsp.id <- gsub("_Reflection", "", allsp.id)
allsp.id <- gsub("_00001", "_blk1", allsp.id)
allsp.id <- gsub("_00004", "_blk2", allsp.id)
allsp.id <- gsub("_00007", "_orn1", allsp.id)
allsp.id <- gsub("_00010", "_orn2", allsp.id)
allsp.id <- gsub("_00013", "_orn3", allsp.id) 

colnames(m.allspec) <- allsp.id
```

## Smooth spectra
Suitable soothing parameter `span = 0.14` is the minimum amount of smoothing to remove spectral noise. 

```{r Smooth spectra, message = FALSE, fig.cap = "**Fig 3.** Check smoothing parameters"}
# check which smoothing parameter to use
plotsmooth(m.allspec, minsmooth = 0.05, maxsmooth = 0.5, curves = 6, ask = FALSE, specnum = 6)

# smooth spectra based on that
allspec.sm <- procspec(m.allspec, opt = "smooth", span = 0.14, fixneg = "zero") 
```

```{r All spectra in color, fig.cap = "**Fig 4.** Spectra based on their color"}
# spectra in their colors
plot(allspec.sm, col = spec2rgb(allspec.sm), cex.lab = 1.5, cex.axis = 1.5)
```

<br>

# Split orange and black patches
### Extract orange patches

Subset then extract
```{r Extract orange patches, message = FALSE}
allspec.orn <- subset(allspec.sm, "orn") #n=343
# average 3 measurements
allspec.orn.avg <- aggspec(allspec.orn, by = 3, FUN = mean, trim = FALSE) 
```

Get spetra
```{r Orange patches - spectra, message = FALSE, results = FALSE}
# get names from list
allspecimens <- names(allspec.orn.avg)
allds <- as.data.frame(allspecimens)

# change names to match
allds$ID <- gsub("MVZ_", "MVZ", allds$allspecimens)
idcat$ID2 <- gsub("MVZ.", "MVZ", idcat$ID)
idcat$ID2 <- gsub("UWBM.", "UWBM", idcat$ID2)
idcat$ID2 <- gsub("UWBMBU", "UWBM", idcat$ID2)


allds$ID2 <- gsub("\\_.*", "", allds$ID) #extract values before _
allds$patch <- gsub(".*_", "", allds$allspecimens) #extract values after _

idcat <- rbind(idcat, data.frame(ID = "wl", cat= "wl", ID2 = "wl")) # to match

# Check if specimen numbers match
# n_distinct(allds$ID2) #n=120
# n_distinct(ct$ID2) #n=120

# Create a new column with specimen type and patch
allds2 <- allds %>% 
  left_join(idcat, by = "ID2", keep=FALSE) 

# Create separate string for category list
allcategory <- allds2$cat
```

Plot average spectra 
```{r Orange patches - plot average spectra by specimen, fig.cap = "**Fig 5.** Spectra based on their specimen category"}
# plot by specimen
asoa <- allspec.orn.avg
colnames(asoa) <- allcategory

aggplot(asoa, by = allcategory, FUN.center = median, ylim = c(0, 65),
        alpha = 0.3, legend = F, cex.lab = 1.5, cex.axis = 1.5, lwd=2)
legend(290, 67, legend = c("BA historic", "BA modern", "BU historic", "BU modern", "BU reference"), col = c("red", "royalblue", "green", "purple", "orange", "yellow"), lty=1, cex=1.2, box.lty=0, lwd=2, bg="transparent")
```


Get Colorimetric variables
```{r Orange patches - colorimetric variables, message = FALSE, results = FALSE}
# use summary function
allsum.orn <- summary(allspec.orn.avg)
setDT(allsum.orn, keep.rownames = TRUE)[]

# convert MVZ names to be consistent with the specimen attribute data
allsum.orn$rn <- gsub("MVZ_", "MVZ.", allsum.orn$rn)

allid.orn <- do.call(rbind, strsplit(allsum.orn$rn, "\\_"))[, 1]

allsum.orn$ID <- allid.orn #specimen ID

# change UWBM to be consistent with the attribute data table
allsum.orn$ID <- gsub("UWBM", "UWBM.BU", allsum.orn$ID)

# Join spectra summary data with attribute data
alldat.orn <- allsum.orn %>%
  left_join(att, by = "ID", keep = F)

# Make just a species category
alldat.orn$sp <- gsub("\\_.*", "", alldat.orn$cat)

# Rename species category for future plotting
alldat.orn$spc <- factor(alldat.orn$sp, levels = c("Bull", "Balt"), labels = c("Bullock's", "Baltimore"))
```

#### Spectra split by species 

```{r Split spectra by species}
# split by species
asoa.ba <- subset(asoa, "Balt")
asoa.bu <- subset(asoa, "Bull")


allcat <- as.data.frame(allcategory)
allcat2 <- allcat %>% 
  filter(allcategory =="wl" | allcategory == "Balt_hist" | allcategory == "Balt_mod")
colnames(asoa.ba) <- allcat2$allcategory

allcat3 <- allcat %>% 
  filter(allcategory =="wl" | allcategory == "Bull_hist" | allcategory == "Bull_mod" | allcategory == "Bull_ref")
colnames(asoa.bu) <- allcat3$allcategory

# plot & save

#png("all_spectra_bullocks.png", width = 800, height = 800, pointsize = 22, res = 100, bg = "transparent")
aggplot(asoa.bu, by = allcat3$allcategory, FUN.center = median, ylim = c(0, 65),
        alpha = 0.3, legend = F, cex.lab = 1.5, cex.axis = 1.5, lwd=2)
legend(290, 67, legend = c("Historic", "Modern", "Reference"), col = c("red", "royalblue", "green"), lty=1, cex=1.2, box.lty=0, lwd=2, bg="transparent", title = "Bullock's oriole")
#dev.off()

#png("all_spectra_baltimore.png", width = 800, height = 800, pointsize = 22, res = 100, bg = "transparent")
aggplot(asoa.ba, by = allcat2$allcategory, FUN.center = median, ylim = c(0, 65),
        alpha = 0.3, legend = F, cex.lab = 1.5, cex.axis = 1.5, lwd=2)
legend(290, 67, legend = c("Historic", "Modern"), col = c("red", "royalblue"), lty=1, cex=1.2, box.lty=0, lwd=2, bg="transparent", title = "Baltimore oriole")
#dev.off()
```


### Extract black patches
Repeat steps above 

```{r Extract black patches, message = FALSE, results = FALSE}
allspec.blk <- subset(allspec.sm, "blk")

# average 3 measurements
allspec.blk.avg <- aggspec(allspec.blk, by = 2, FUN = mean, trim = FALSE) 

# Get colorimetric values
allsum.blk <- summary(allspec.blk.avg)
setDT(allsum.blk, keep.rownames = TRUE)[]

# convert MVZ names to be consistent with the specimen attribute data
allsum.blk$rn <- gsub("MVZ_", "MVZ.", allsum.blk$rn)

allid.blk <- do.call(rbind, strsplit(allsum.blk$rn, "\\_"))[, 1]

allsum.blk$ID <- allid.blk #specimen ID

allsum.blk$ID <- gsub("UWBM", "UWBM.BU", allsum.blk$ID)


# Join spectra summary data with attribute data
alldat.blk <- allsum.blk %>%
  left_join(att, by = "ID", keep = F)

# Make just a species category
alldat.blk$sp <- gsub("\\_.*", "", alldat.blk$cat)

# Rename species category for future plotting
alldat.blk$spc <- factor(alldat.blk$sp, levels = c("Bull", "Balt"), labels = c("Bullock's", "Baltimore"))
```


<br>


# Colorimetric variables
List of variables of interest (from Pavo package; references available there)
 - `B1`: total brightness; sum of relative reflectance over entire spectral range (area under the curve) 
 - `B2`: mean brightness; mean relative reflectance over entire spectral range 
 - `S1`: chroma; relative contribution of a spectral range to the total brightness (B1) 
 - `S9`: carotenoid chroma; (R700 - R450)/R700 
 - `H3`: hue/wavelength at Rmid; sensitive to noisy spectra

### Compare boxplots across specimen categories
Orange patches
```{r Boxplot across specimens - orange}
dat <- alldat.orn
plot(B1 ~ cat, data = dat, ylab = "Total brightness (B1)", xlab = "Specimen category")
plot(B2 ~ cat, data = dat, ylab = "Mean brightness (B2)", xlab = "Specimen category") # same as above, just different y axis
plot(S9 ~ cat, data = dat, ylab = "Carotenoid chroma (S9)", xlab = "Specimen category")
plot(H3 ~ cat, data = dat, ylab = "Hue (H3)", xlab = "Specimen category")
```

Black patchess 
```{r Boxplot across specimens - black}
dat <- alldat.blk
plot(B1 ~ cat, data = dat, ylab = "Total brightness (B1)", xlab = "Specimen category")
```

### Check data 
Histograms
```{r Histograms}
# Oranges
hist(alldat.orn$B1)
hist(alldat.orn$B2)
hist(alldat.orn$S9)
hist(alldat.orn$H3)

# Black
hist(alldat.blk$B1)
```

Normality
```{r qqPlots}
# Oranges
qqPlot(alldat.orn$B1)
qqPlot(alldat.orn$B2)
qqPlot(alldat.orn$S9)
qqPlot(alldat.orn$H3)

# Black
qqPlot(alldat.blk$B1)
```


<br>

# Statistical analyses
## H1. Have specimens faded over time? 
To test for specimen fauxing, look at colorimetric measures over time.

### 1. Orange patches over time

Check brightness, carotenoid chroma, hue

1) Brightness
```{r Orange - brightness x date, message = FALSE}
# Both species
lm_orn_both_b1 <- lm(B1 ~ date, data = alldat.orn)
summary(lm_orn_both_b1)

# Bullock's
lm_orn_BU_b1 <- lm(B1 ~ date, data = alldat.orn[which(alldat.orn$sp == "Bull"),])
summary(lm_orn_BU_b1)

# Baltimore
lm_orn_BA_b1 <- lm(B1 ~ date, data = alldat.orn[which(alldat.orn$sp == "Balt"),])
summary(lm_orn_BA_b1)

# Plot both
ggplot(alldat.orn, aes(x = date, y = B1, shape = spc, color = spc)) +
  geom_point(size = 2) +
  stat_smooth(method = lm, aes(fill = spc), se = T) +
  theme_classic() +
  mytheme +
  stat_fit_glance(method = "lm", label.x = "right", label.y = "bottom",
                        method.args = list(formula = y ~ x), size = 5, 
                        aes(label = sprintf('R^2~"="~%.3f~~italic(p)~"="~%.3f',
                                            stat(..r.squared..), stat(..p.value..))), parse = TRUE) + 
  labs(title = "Orange patches only", y = "Total brightness (B1)", x = "Collection date", color = "Species", fill = "Species", shape = "Species") +
  scale_color_manual(values = pal1) +
  scale_fill_manual(values = pal1)
```

2) Carotenoid chroma 
```{r Orange - chroma x date, message = FALSE}
# Both species
lm_orn_both_s9 <- lm(S9 ~ date, data = alldat.orn)
summary(lm_orn_both_s9)

# Bullock's
lm_orn_BU_s9 <- lm(S9 ~ date, data = alldat.orn[which(alldat.orn$sp == "Bull"),])
summary(lm_orn_BU_s9)

# Baltimore
lm_orn_BA_s9 <- lm(S9 ~ date, data = alldat.orn[which(alldat.orn$sp == "Balt"),])
summary(lm_orn_BA_s9)

# Plot both
ggplot(alldat.orn, aes(x = date, y = S9, shape = spc, color = spc)) +
  geom_point(size = 2) +
  stat_smooth(method = lm, aes(fill = spc), se = T) +
  theme_classic() +
  mytheme +
  stat_fit_glance(method = "lm", label.x = "right", label.y = "bottom",
                        method.args = list(formula = y ~ x), size = 5, 
                        aes(label = sprintf('R^2~"="~%.3f~~italic(p)~"="~%.3f',
                                            stat(..r.squared..), stat(..p.value..))), parse = TRUE) + 
  labs(title = "Orange patches only", y = "Carotenoid chroma (S9)", x = "Collection date", color = "Species", fill = "Species", shape = "Species") +
  scale_color_manual(values = pal1) +
  scale_fill_manual(values = pal1)
```

3) Hue 
```{r Orange - hue x date, message = FALSE}
# Both species
lm_orn_both_h3 <- lm(H3 ~ date, data = alldat.orn)
summary(lm_orn_both_h3)

# Bullock's
lm_orn_BU_h3 <- lm(H3 ~ date, data = alldat.orn[which(alldat.orn$sp == "Bull"),])
summary(lm_orn_BU_h3)

# Baltimore
lm_orn_BA_h3 <- lm(H3 ~ date, data = alldat.orn[which(alldat.orn$sp == "Balt"),])
summary(lm_orn_BA_h3)

# Plot both
ggplot(alldat.orn, aes(x = date, y = H3, shape = spc, color = spc)) +
  geom_point(size = 2) +
  stat_smooth(method = lm, aes(fill = spc), se = T) +
  theme_classic() +
  mytheme +
  stat_fit_glance(method = "lm", label.x = "right", label.y = "bottom",
                        method.args = list(formula = y ~ x), size = 5, 
                        aes(label = sprintf('R^2~"="~%.3f~~italic(p)~"="~%.3f',
                                            stat(..r.squared..), stat(..p.value..))), parse = TRUE) + 
  labs(title = "Orange patches only", y = "Hue (H3)", x = "Collection date", color = "Species", fill = "Species", shape = "Species") +
  scale_color_manual(values = pal1) +
  scale_fill_manual(values = pal1)
```

### 2. Black patches over time

Check brightness

```{r Black - brightness x date, message = FALSE}
lm_black <- lm(B1 ~ date, data = alldat.blk)
summary(lm_black)

# plot
ggplot(alldat.blk, aes(x = date, y = B1, shape = spc, color = spc)) +
  geom_point(size = 2) +
  stat_smooth(method = lm, aes(fill = spc), se = T) +
  theme_classic() +
  mytheme +
  stat_fit_glance(method = "lm", label.x = "right", label.y = "bottom",
                        method.args = list(formula = y ~ x), size = 5, 
                        aes(label = sprintf('R^2~"="~%.3f~~italic(p)~"="~%.3f',
                                            stat(..r.squared..), stat(..p.value..))), parse = TRUE) + 
  labs(title = "Black patches only", y = "Brightness (B1)", x = "Collection date", color = "Species", fill = "Species", shape = "Species") +
  scale_color_manual(values = pal1) +
  scale_fill_manual(values = pal1)
```


<br>

## H2. Have landuse changes affected Bullock's orioles?

Compare reference vs. hybrid zone

```{r H2. Reference vs hybrid zone}
# Set a new variable indicating hybrid zone or outside
alldat.orn$loc <- ifelse(alldat.orn$cat == "Bull_ref", "Outside", "Hybrid zone") 

# Separate Bullock's
bullocks <- alldat.orn[which(alldat.orn$sp == "Bull"),]

# List for comparisons
bucomp <- list(c("Bull_ref", "Bull_hist"), c("Bull_hist", "Bull_mod"), c("Bull_ref", "Bull_mod"))
```


1. Brightness
```{r compare across bullocks groups - brightness, message = FALSE, warning = FALSE}
# Boxplots
h2a <- ggplot(bullocks, aes(x = cat, y = B1)) +
  stat_boxplot(aes(x = cat, y = B1), geom = "errorbar", position = position_dodge(width = .75), width = .5) +
  geom_boxplot(outlier.size = 1.5, position = position_dodge(width = .75), col = "black", fill = "#fa8500") +
  theme_classic()+ 
  stat_compare_means(comparisons = bucomp, label.y = c(11900, 11600, 12200), method = "t.test", label = "p.signif", size = 6) + 
  mytheme +
  labs(y = "Total brightness (B1)") +
  scale_x_discrete(name = "Specimen type", limits = c("Bull_ref", "Bull_hist", "Bull_mod"), labels = c("Reference", "Historic", "Modern")) +
  ylim(7500,12510)
```

2. Chroma
```{r compare across bullocks groups - chroma, message = FALSE, warning = FALSE}
# Boxplots
h2b <- ggplot(bullocks, aes(x = cat, y = S9)) +
  stat_boxplot(aes(x = cat, y = S9), geom = "errorbar", position = position_dodge(width = .75), width = .5) +
  geom_boxplot(outlier.size = 1.5, position = position_dodge(width = .75), col = "black", fill = "#fa8500") +
  theme_classic()+ 
  stat_compare_means(comparisons = bucomp, label.y = c(0.96, 0.966, 0.972), method = "t.test", label = "p.signif", size = 6) + 
  mytheme +
  labs(y = "Caronetoid chroma (S9)") +
  scale_x_discrete(name = "Specimen type", limits = c("Bull_ref", "Bull_hist", "Bull_mod"), labels = c("Reference","Historic", "Modern")) +
  ylim(0.90,0.973)
```


3. Hue

```{r compare across bullocks groups - hue, message = FALSE, warning = FALSE}
# Boxplots
h2c <- ggplot(bullocks, aes(x = cat, y = H3)) +
  stat_boxplot(aes(x = cat, y = H3), geom = "errorbar", position = position_dodge(width = .75), width = .5) +
  geom_boxplot(outlier.size = 1.5, position = position_dodge(width = .75), col = "black", fill = "#fa8500") +
  theme_classic()+ 
  stat_compare_means(comparisons = bucomp, label.y = c(569, 567, 571), method = "t.test", label = "p.signif", size = 6) + 
  mytheme +
  labs(y = "Hue (H3)") +
  scale_x_discrete(name = "Specimen type", limits = c("Bull_ref", "Bull_hist", "Bull_mod"), labels = c("Reference","Historic", "Modern")) +
  ylim(537,574)
```


```{r}
pg1 <- plot_grid(
  h2a + theme(legend.position="none"),
  h2b + theme(legend.position="none"),
  h2c + theme(legend.position="none"),
  align = 'vh',
  labels = c("A", "B", "C"),
  hjust = -1,
  nrow = 1, label_size = 16
)

plot_grid(pg1)

ggsave("Figure_h2.png", plot=last_plot(), width=400, height=125, units="mm", dpi=600, scale=T)
```



<br>

## H3. Are color changes only in the hybrid zone? 

Linear models
```{r}
lm_orn_hz_b1 <- lm(B1 ~ date, data = bullocks[which(bullocks$loc == "Hybrid zone"),])
summary(lm_orn_hz_b1) # p = 0.142  

lm_orn_hz_s9 <- lm(S9 ~ date, data = bullocks[which(bullocks$loc == "Hybrid zone"),])
summary(lm_orn_hz_s9) # p = 8.99e-05 ***

lm_orn_hz_h3 <- lm(H3 ~ date, data = bullocks[which(bullocks$loc == "Hybrid zone"),])
summary(lm_orn_hz_h3) # p = 2.04e-05 ***
```

#### Plots

1. Brightness
```{r Compare across bullocks hybrid zone - brightness, message = FALSE}
# Regression over time 
h3a <- ggplot(bullocks, aes(x = date, y = B1, shape = loc, color = loc)) +
  geom_point(size = 2) +
  stat_smooth(method = lm, aes(fill = loc), se = T) +
  theme_classic() +
  mytheme +
  stat_fit_glance(method = "lm", 
                        method.args = list(formula = y ~ x), size = 5, 
                        aes(label = sprintf('R^2~"="~%.3f~~italic(p)~"="~%.3g',
                                            stat(..r.squared..), stat(..p.value..))), parse = TRUE) + 
  labs(y = "Total brightness (B1)", x= "Collection date", color = "Location", fill = "Location", shape = "Location") +
  scale_color_manual(values = pal1) +
  scale_fill_manual(values = pal1)
```

2. Chroma
```{r Compare across bullocks hybrid zone - chroma, message = FALSE}
h3b <- ggplot(bullocks, aes(x = date, y = S9, shape = loc, color = loc)) +
  geom_point(size = 2) +
  stat_smooth(method = lm, aes(fill = loc), se = T) +
  theme_classic() +
  mytheme +
  stat_fit_glance(method = "lm",
                        method.args = list(formula = y ~ x), size = 5, 
                        aes(label = sprintf('R^2~"="~%.3f~~italic(p)~"="~%.3g',
                                            stat(..r.squared..), stat(..p.value..))), parse = TRUE) + 
  labs(y = "Carotenoid chroma (S9)", x = "Collection date", color = "Location", fill = "Location", shape = "Location") +
  scale_color_manual(values = pal1) +
  scale_fill_manual(values = pal1)
```


3. Hue
```{r Compare across bullocks hybrid zone - hue, message = FALSE}
h3c <- ggplot(bullocks, aes(x = date, y = H3, shape = loc, color = loc)) +
  geom_point(size = 2) +
  stat_smooth(method = lm, aes(fill = loc), se = T) +
  theme_classic() +
  mytheme +
  stat_fit_glance(method = "lm", 
                        method.args = list(formula = y ~ x), size = 5, 
                        aes(label = sprintf('R^2~"="~%.3f~~italic(p)~"="~%.3g',
                                            stat(..r.squared..), stat(..p.value..))), parse = TRUE) + 
  labs(y = "Hue (H3)", x = "Collection date", color = "Location", fill = "Location", shape = "Location") +
  scale_color_manual(values = pal1) +
  scale_fill_manual(values = pal1)
```

Merge 

```{r Merge all plots, message = FALSE}
pg <- plot_grid(
  h3a + theme(legend.position="none"),
  h3b + theme(legend.position="none"),
  h3c + theme(legend.position="none"),
  align = 'vh',
  labels = c("A", "B", "C"),
  hjust = -1,
  nrow = 1, label_size = 16
)

leg <- get_legend(h3a + theme(legend.box.margin = margin(0,0,0,12)))

plot_grid(pg, leg, rel_widths = c(6, 0.8))

ggsave("Figure_h3.png", plot=last_plot(), width=400, height=125, units="mm", dpi=600, scale=T)
```


<br>




# Avian visual models

Using smoothed and averaged data: `allspec.orn.avg` and `allspec.blk.avg` 

## Noise-weighted distances with the Receptor Noise Model 

```{r, message= FALSE}
vismod.orn <- vismodel(allspec.orn.avg,
  visual = "avg.uv", achromatic = "bt.dc", #blue tit double cone
  illum = "D65", relative = FALSE)
summary(vismod.orn)


# Get color distances
vismod.orn.dist <- coldist(vismod.orn,
  noise = "neural", achromatic = TRUE, n = c(1, 2, 2, 4),
  weber = 0.1, weber.achro = 0.1
)


# bootstrap color distances
cate <- allcategory[-1] # get list made from above but remove wl from vector

vm.orn.dist <- bootcoldist(vismod.orn, by = cate, n = c(1,2,2,4), weber=0.1, achromatic = FALSE)
#vm.orn.dist

#achromatic
vm.orn.dist.achro <- bootcoldist(vismod.orn, by = cate, n = c(1,2,2,4), weber=0.1, achromatic = TRUE, weber.achro = 0.1)
```

```{r, fig.cap = "**Fig.** Chromatic contrasts (dS), horizontal."}
# plot
plot(vm.orn.dist[, 1], 
     ylim = c(0, 5), 
     pch = 21, 
     bg = 1, 
     cex = 2, 
     xaxt = 'n', 
     xlab = 'Centroid comparison', 
     ylab = 'Chromatic contrast (dS)')
axis(1, at = 1:10, labels = rownames(vm.orn.dist))
segments(1:10, vm.orn.dist[, 2], 1:10, vm.orn.dist[, 3], lwd = 2)  # Add CI's
abline(h = 1, lty = 3, lwd = 2)  # Add a 'threshold' line at dS = 1
```

```{r, fig.cap = "**Fig.** Chromatic contrasts (dS), vertical."}
# ggplot
# need to convert matrix into a usable data frame
vod <- as.data.frame(as.table(vm.orn.dist))
vod2 <- pivot_wider(vod, names_from = Var2, values_from = Freq)


ggplot(vod2, aes(x=Var1, y=dS.mean)) +
  geom_errorbar(aes(ymin = dS.lwr, ymax = dS.upr), width=.6, position = position_dodge(width=1), size=1) +
  geom_point(position = position_dodge(width=1), size=5) +
  theme_classic()+ 
  mytheme + 
  theme(text=element_text(family="sans")) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip() +
  labs(x="Centroid comparison", y = "Chromatic contrast (\u0394S)") +
  theme(panel.background = element_rect(fill = "transparent"), # bg of the panel
    plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
    panel.grid.major = element_blank(), # get rid of major grid
    panel.grid.minor = element_blank(), # get rid of minor grid
    legend.background = element_rect(fill = "transparent"), # get rid of legend bg
    legend.box.background = element_rect(fill = "transparent"))
ggsave("chromatic_contrast.png", plot = last_plot(), width = 200, height = 120, units = "mm", dpi = 300,  bg = "transparent")
```

```{r, fig.cap = "**Fig.** Achromatic contrasts (dS), vertical."}
# achromatic
vod2 <- as.data.frame(as.table(vm.orn.dist.achro))
vod3 <- pivot_wider(vod2, names_from = Var2, values_from = Freq)

ggplot(vod3, aes(x=Var1, y=dL.mean)) +
  geom_errorbar(aes(ymin = dL.lwr, ymax = dL.upr), width=.6, position = position_dodge(width=1), size=1) +
  geom_point(position = position_dodge(width=1), size=5) +
  theme_classic()+ 
  mytheme +
  theme(text=element_text(family="sans")) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip() +
  labs(x="Centroid comparison", y = "Achromatic contrast (\u0394L)") +
  theme(panel.background = element_rect(fill = "transparent"), # bg of the panel
    plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
    panel.grid.major = element_blank(), # get rid of major grid
    panel.grid.minor = element_blank(), # get rid of minor grid
    legend.background = element_rect(fill = "transparent"), # get rid of legend bg
    legend.box.background = element_rect(fill = "transparent"))
ggsave("achromatic_contrast.png", plot = last_plot(), width = 200, height = 120, units = "mm", dpi = 300,  bg = "transparent")
```

### Convert color distances to XYZ coordinates
```{r}
vismod.orn.cc <- jnd2xyz(vismod.orn.dist, ref1 = "l", axis1 = c(1, 0, 0), ref2 = NULL)
plot(vismod.orn.cc, theta=55, phi=25, col=spec2rgb(allspec.orn.avg))
jndplot(vismod.orn.cc, theta=55, phi=25, col=spec2rgb(allspec.orn.avg), arrow.labels = TRUE)
```

<br>

## Test for differences in groups 
- Are the samples statistically separate in color space? 

https://oup.silverchair-cdn.com/oup/backfile/Content_public/Journal/beheco/29/3/10.1093_beheco_ary017/1/ary017_suppl_supplementary_material.html?Expires=1614112080&Signature=oDIUd-WkV00PmIsMMzpiW6mE6w0d0vJhS~Qly7ck5B7mReHRnnEVBmzzipJMN~sLsXOgoZx-yhj7fEPu6~7YARBU0DdVht7BhU2wNLd~upjxfiqnaoNhPtJqQ9NcYIEGR92pXG3y15XVojmhpHK9GnWlgty5-JJN5Cyck5mNXq6m~-OcQrpJEDwxtlikhRsC9NykQsIb4lN0qn1XZNh7I6fYjzDyqfAU8DZcvkXCOz0f419HmGax~nMZi7HmPM4qLQPCtyYJlDCgCE1tW-YyYwoTN9Y~nCLE4k28qFgofFSrNfIvGdq4X1SzEGkzSaAo3YlbpguAB7orp-pGPBRQzw__&Key-Pair-Id=APKAIE5G5CRDK6RD3PGA

1) Using *distance-based PERMANOVA* (Maia & White 2018): using `adonis` fx from R package `vegan` (distance PERMANOVA)


```{r message=FALSE, warning=FALSE, results=FALSE}
library(vegan)
library(MCMCglmm)
library(RColorBrewer)
library(biotools)

mat <- dist(coldist2mat(vismod.orn.dist)[['dS']])
# group <- substring(rownames(as.matrix(mat)), 1, 1)
# use at.orn instead as a grouping factor

#### Test for separation among groups
# test assumption of homogeneity of variances
bdisp <- betadisper(mat, cate, type='centroid')
anova(bdisp) #0.01229 * 
# Groups have unequal variances, which can influence the results of the PERMANOVA. 

TukeyHSD(bdisp) # only sig for Baltmod-Balthist and Bullmod-Balthist

pmanova <- adonis(mat~cate)
pmanova
#Permutation: free
#Number of permutations: 999

#           Df SumsOfSqs MeanSqs F.Model      R2 Pr(>F)    
#cate        4    2481.2  620.31  10.783 0.2745  0.001 ***
#Residuals 114    6557.9   57.53         0.7255           
#Total     118    9039.1                 1.0000           
```

Testing for above-threshold mean differences between groups: [done]
We will use a bootstrap approach to consider the uncertainty on the mean difference between groups when comparing it to a threshold value of 1 JND.
```{r}
# vm.orn.dist <- bootcoldist(vismod.orn, by = cate, n = c(1,2,2,4), weber=0.1, achromatic = FALSE)

#vm.orn.dist
```


2) On XYZ coordinates, apply a MANOVA test (Cartesian MANOVA)

`vismod.orn.cc` <- jnd2xyz(vismod.orn.dist, ref1 = "l", axis1 = c(1, 0, 0), ref2 = NULL)

```{r}
plot(vismod.orn.cc, col=c("red", "blue", "yellow", "black", "green", "orange"), cex=1.5) 
# change color palette

#### Test for separation among groups
# Perform Box's M-test for homogeneity of variances to test the assumption of equal covariances

boxM(vismod.orn.cc[,c('x', 'y', 'z')], cate)
# Chi-Sq (approx.) = 36.659, df = 24, p-value = 0.0473

# all groups have equal covariances

#### run MANOVA on cartesian coordinates
summary(manova(lm(cbind(x,y,z)~cate, data = vismod.orn.cc)))
#           Df Pillai approx F num Df den Df    Pr(>F)    
#at.orn      4 0.91818    12.57     12    342 < 2.2e-16 ***


```


- Is this separation perceptually discriminable? 

-> Estimate distance in color space between-group geometric means rather than through average pairwise distance or volume-overlap based 
    This is `vm.orn.dist`




## Color space
Though these models do not account for receptor noise (and thus do not allow an estimate of JNDs), they presents several advantages. First, they make for a very intuitive representation of colour points accounting for attributes of the colour vision of the signal receiver. Second, they allow for the calculation of several interesting variables that represent colour. e.g. hue can be estimated from the angle of the point relative to the xy plane (blue-green-red) and the z axis (UV); saturation can be estimated as the distance of the point from the achromatic centre.

```{r, results=FALSE}
# original
vismod.orn <- vismodel(allspec.orn.avg,
  visual = "avg.uv", achromatic = "bt.dc", #blue tit double cone
  illum = "D65", relative = FALSE)

# adjust parameters for color space model, bright viewing conditions and relative = T
vismod.orn2 <- vismodel(allspec.orn.avg, visual = "avg.uv", achromatic = "bt.dc", scale = 10000, relative = TRUE)

# create color space
tetra.orn2 <- colspace(vismod.orn2, space = "tcs") #
head(tetra.orn2)
# r.vec is the measure of saturation

# add attribute data
torn <- as.data.frame(tetra.orn2)
tcat <- att %>%  # created from above
  dplyr::select(ID, cat, date)
  

torn$ID <- tcat$ID
torn$cat <- tcat$cat
torn$date <- tcat$date
torn$sp <- gsub("\\_.*", "", torn$cat)
torn$type <- gsub(".*_", "", torn$cat)

torn2 <- torn %>% 
  dplyr::select(ID, cat, sp, type, date, r.vec)
```


#### split by species
```{r}
#### like figures before
bacomp <- list(c("Balt_ref", "Balt_hist"), c("Balt_hist", "Balt_mod"), c("Balt_ref", "Balt_mod"))
bucomp <- list(c("Bull_ref", "Bull_hist"), c("Bull_hist", "Bull_mod"), c("Bull_ref", "Bull_mod"))

# Bullocks
toba <- torn2[which(torn2$sp == "Balt"),]
tobu <- torn2[which(torn2$sp == "Bull"),]
  
ggplot(tobu, aes(x=cat, y=r.vec)) +
  stat_boxplot(aes(x=cat, y=r.vec), geom="errorbar", position = position_dodge(width=.75), width=.5) +
  geom_boxplot(outlier.size=1.5, position=position_dodge(width=.75), col="black", fill = "#fa8500") +
  theme_classic()+ 
  stat_compare_means(comparisons = bucomp, method = "t.test", label.y = c(0.41, 0.42, 0.43),label = "p.signif", size = 6) +
  theme(axis.text=element_text(size=16, color="black"),
        axis.title=element_text(size=18,face="bold",color="black"),
        axis.text.x=element_text(size=16, color="black"), 
        axis.text.y=element_text(size=16, color="black"),
        legend.text = element_text(size=16, color="black"),
        legend.title = element_text(size=16, color="black", face="bold"))+
  labs(y = "Saturation") +
  scale_x_discrete(name="Bullock's oriole", limits=c("Bull_ref", "Bull_hist","Bull_mod"), labels=c("Reference","Historic", "Modern"))

ggsave("bu_orn_saturation_cat.tiff", plot = ggplot2::last_plot(), width=150, height=180, units="mm", dpi=300)
```

<br>

# Tetrahedral plot
```{r}
### plots
plot(tetra.orn2, col = spec2rgb(allspec.orn.avg), perspective = TRUE,  pch = 21, cex=0.5, zoom=1, phi=30)
# orange points in a tetrachromatic colorspace, as modelled according to blue tit visual system
```

<br>

# PCA
```{r PCA, message=FALSE, warning=FALSE}
library(ggfortify)
library(cluster)
library(grid)
library(gridExtra)

spec.bin <- procspec(allspec.orn.avg, opt = c("bin", "center"))
colnames(spec.bin) <- allcategory 

spec.bin <- t(spec.bin) 
spec.bin <- spec.bin[-1, ]
pca1 <- prcomp(spec.bin, scale. = TRUE)

summary(pca1) #PC1 explains 65% of the variation in spectral shape and describes the ratio of short to long wavelengths reflected

ao <- as.character(cate)
sb <- cbind(spec.bin, ao)

#autoplot(pca1, data=sb, colour="ao")

autoplot(pca1, data=sb, colour="ao", frame=TRUE, frame.type = "norm")
```

Subset for better visualization
```{r, message = FALSE, results=FALSE}
####
## Remove for better visualization
### change names for subsetting
soa <- allspec.orn.avg
colnames(soa) <- allcategory
```

### Within Baltimore, historic vs modern
```{r, message = FALSE, results=FALSE}
baltmodhist <- subset(soa, c("Balt_mod", "Balt_hist")) # n = 40 but names changed? 

spec.bin.bamh <- procspec(baltmodhist, opt = c("bin", "center"))

spec.bin.bamh <- t(spec.bin.bamh) 
spec.bin.bamh <- spec.bin.bamh[-1, ]
pca.bamh <- prcomp(spec.bin.bamh, scale. = TRUE)

summary(pca.bamh) # 71.7% of variation

bamh <- as.character(colnames(baltmodhist))
bamh <- gsub("\\..*", "", bamh) # remove everything after "."
bamh <- bamh[-1]
sb.bamh <- cbind(spec.bin.bamh, bamh) 

autoplot(pca.bamh, data=sb.bamh, colour = "bamh", frame=TRUE, frame.type = "norm", legendlabs = c("Baltimore historic", "Baltimore modern")) + 
  theme_classic() +
  mytheme+
  labs(fill="Specimen type", color="Specimen type")
ggsave("pca_baltimore.tiff", plot = ggplot2::last_plot(), width=200, height=150, units="mm", dpi=300)
```

### Within Bullock's, historic vs modern
```{r, message = FALSE, results=FALSE}
bullmodhist <- subset(soa, c("Bull_mod", "Bull_hist")) # n = 40 but names changed? 

spec.bin.bumh <- procspec(bullmodhist, opt = c("bin", "center"))

spec.bin.bumh <- t(spec.bin.bumh) 
spec.bin.bumh <- spec.bin.bumh[-1, ]
pca.bumh <- prcomp(spec.bin.bumh, scale. = TRUE)

summary(pca.bumh) # 55.5% of variation

bumh <- as.character(colnames(bullmodhist))
bumh <- gsub("\\..*", "", bumh) # remove everything after "."
bumh <- bumh[-1]
sb.bumh <- cbind(spec.bin.bumh, bumh) 

autoplot(pca.bumh, data=sb.bumh, colour = "bumh", frame=TRUE, frame.type = "norm") + 
  theme_classic() +
  mytheme +
  labs(fill="Specimen type", color="Specimen type")

ggsave("pca_bullocks.tiff", plot = ggplot2::last_plot(), width=200, height=150, units="mm", dpi=300)
```


### Within Bullocks, all 3
```{r, message = FALSE, results=FALSE}
bullmodhistref <- subset(soa, c("Bull_mod", "Bull_hist", "Bull_ref")) # n = 40 but names changed? 

spec.bin.bumhr <- procspec(bullmodhistref, opt = c("bin", "center"))

spec.bin.bumhr <- t(spec.bin.bumhr) 
spec.bin.bumhr <- spec.bin.bumhr[-1, ]
pca.bumhr <- prcomp(spec.bin.bumhr, scale. = TRUE)

bumhr <- as.character(colnames(bullmodhistref))
bumhr <- gsub("\\..*", "", bumhr) # remove everything after "."
bumhr <- bumhr[-1]
sb.bumhr <- cbind(spec.bin.bumhr, bumhr) 

autoplot(pca.bumhr, data=sb.bumhr, colour = "bumhr", frame=TRUE, frame.type = "norm") + 
  theme_classic() +
  mytheme +
  labs(fill="Specimen type", color="Specimen type")

ggsave("pca_bullocks_all.tiff", plot = ggplot2::last_plot(), width=200, height=150, units="mm", dpi=300)
```

## Contrast between species

### Historic 
```{r, message = FALSE, results=FALSE}
## Historic
intercolorhist <- subset(soa, c("Bull_hist", "Balt_hist")) # n = 40 but names changed? 

spec.bin.ich <- procspec(intercolorhist, opt = c("bin", "center"))

spec.bin.ich <- t(spec.bin.ich) 
spec.bin.ich <- spec.bin.ich[-1, ]
pca.ich <- prcomp(spec.bin.ich, scale. = TRUE)

ich <- as.character(colnames(intercolorhist))
ich <- gsub("\\..*", "", ich) # remove everything after "."
ich <- ich[-1]
sb.ich <- cbind(spec.bin.ich, ich) 

autoplot(pca.ich, data=sb.ich, colour = "ich", frame=TRUE, frame.type = "norm") + 
  theme_classic() +
  mytheme +
  labs(fill="Specimen type", color="Specimen type")

ggsave("pca_inter_historic.tiff", plot = ggplot2::last_plot(), width=200, height=150, units="mm", dpi=300)
```


### Modern
```{r, message = FALSE, results=FALSE}
intercolormod <- subset(soa, c("Bull_mod", "Balt_mod")) # n = 40 but names changed? 

spec.bin.icm <- procspec(intercolormod, opt = c("bin", "center"))

spec.bin.icm <- t(spec.bin.icm) 
spec.bin.icm <- spec.bin.icm[-1, ]
pca.icm <- prcomp(spec.bin.icm, scale. = TRUE)

icm <- as.character(colnames(intercolormod))
icm <- gsub("\\..*", "", icm) # remove everything after "."
icm <- ich[-1]
sb.icm <- cbind(spec.bin.icm, icm) 

autoplot(pca.icm, data=sb.icm, colour = "icm", frame=TRUE, frame.type = "norm") + 
  theme_classic() +
  mytheme +
  labs(fill="Specimen type", color="Specimen type")

ggsave("pca_inter_modern.tiff", plot = ggplot2::last_plot(), width=200, height=150, units="mm", dpi=300)
```


**Figure out how to color autoplots then arrange them side by side** 